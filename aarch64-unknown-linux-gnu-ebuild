#!/bin/sh
# Copyright 2008-2019 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

if [ -z "${CHOST}" ] ; then
	CHOST=${0##*/}
	CHOST=${CHOST%-ebuild}
	CHOST=${CHOST#ebuild-}
fi
export CHOST

BROOT=""
if [ "${BROOT}" = "@"GENTOO_PORTAGE_EPREFIX"@" ] ; then
	BROOT=""
fi

: ${EPREFIX=}
: ${SYSROOT=${BROOT}/usr/${CHOST}}
: ${PORTAGE_CONFIGROOT=${SYSROOT}${EPREFIX}}
export EPREFIX SYSROOT PORTAGE_CONFIGROOT

if [ -z "${CHOST}" ] || [ ! -d "${SYSROOT}" ] ; then
	echo "cross-ebuild: CHOST is not set properly"
	exit 1
fi

# Portage defaults CBUILD to CHOST, so we have to remove CHOST
# from the env to get a "good" value for CBUILD
query_vars="CBUILD CFLAGS CXXFLAGS CPPFLAGS LDFLAGS"
clean_vars="${query_vars} CHOST SYSROOT PORTAGE_CONFIGROOT"
eval $(env $(printf -- '-u %s ' ${clean_vars}) \
	portageq envvar -v ${query_vars} | sed s:^:_E_:)
: ${CBUILD=${_E_CBUILD}}
: ${BUILD_CFLAGS=${_E_CFLAGS}}
: ${BUILD_CXXFLAGS=${_E_CXXFLAGS}}
: ${BUILD_CPPFLAGS=${_E_CPPFLAGS}}
: ${BUILD_LDFLAGS=${_E_LDFLAGS}}
export CBUILD BUILD_CFLAGS BUILD_CXXFLAGS BUILD_CPPFLAGS BUILD_LDFLAGS

# for rust
export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-unknown-linux-gnu-gcc
export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS="-C link-arg=-Wl,-rpath-link,/usr/lib/gcc/aarch64-unknown-linux-gnu/10.2.0"
export ECARGO_EXTRA_ARGS="--target=$CHOST"

#: ${CROSS_CMD:=emerge --root-deps=rdeps}
: ${CROSS_CMD:=ebuild}
exec ${CROSS_CMD} "$@"
